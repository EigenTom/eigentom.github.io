I"<h1 id="使用0d6d补丁解决xdci睡眠唤醒">使用0D/6D补丁解决XDCI睡眠唤醒</h1>

<blockquote>
  <p>”sudo pmset sleepnow“</p>
</blockquote>

<p>根据 <code class="language-plaintext highlighter-rouge">ACPI</code> 规范, <code class="language-plaintext highlighter-rouge">_PRW</code> 方法定义了设备的唤醒方法。该函数的返回值是一个包含 $2$ 个或更多字节的数据包。</p>

<p>一些机型内建的子设备 (如 <code class="language-plaintext highlighter-rouge">USB</code> 控制器, 内建声卡, 无线网卡等) 的 <code class="language-plaintext highlighter-rouge">_PRW</code> 与 <code class="language-plaintext highlighter-rouge">macOS</code> 冲突，一旦计算机进入睡眠状态, 就会被这些子设备立即唤醒。编写适当的 <code class="language-plaintext highlighter-rouge">ACPI Hotpatch</code> 可以解决这一问题. 一般来说这些 <code class="language-plaintext highlighter-rouge">_PRW</code> 数据包的第一个字节为 <code class="language-plaintext highlighter-rouge">0D</code> 或 <code class="language-plaintext highlighter-rouge">6D</code> 。因此，这种补丁也被称为<code class="language-plaintext highlighter-rouge">0D/6D</code> 补丁，也称为二次唤醒补丁.</p>

<p>一般而言, <code class="language-plaintext highlighter-rouge">_PRW</code> 数据包的第二个返回字节主要是 <code class="language-plaintext highlighter-rouge">03</code> 或 <code class="language-plaintext highlighter-rouge">04</code> 。将该字节修改为 <code class="language-plaintext highlighter-rouge">0</code> 就完成了 <code class="language-plaintext highlighter-rouge">0D/6D</code> 补丁。</p>

<p>然而, 对杯具的 <code class="language-plaintext highlighter-rouge">ThinkPad X1 Carbon 6th (20KH)</code> 和 <code class="language-plaintext highlighter-rouge">ThinkPad X1 Yoga 3rd (20LE)</code> 而言, 单纯地将 <code class="language-plaintext highlighter-rouge">6D-03 / 6D-04</code> 重命名为 <code class="language-plaintext highlighter-rouge">6D - 00</code> 并不能解决问题, 有时它们还会在几次成功的睡眠过程之后便由于 内建的 <code class="language-plaintext highlighter-rouge">JHL6540 Thunderbolt3 USB-3.1 Controller</code> 持续唤醒, 而再也无法进入睡眠状态. 使用</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>pmset -g log|grep -e " Sleep.*due to" -e " Wake.*due to" -e "DarkWake.*due to"
</pre></td></tr></tbody></table></code></pre></div></div>
<p>指令检查睡眠/唤醒原因, 总能看到如下的一行:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> +0800 Wake DarkWake to FullWake from Standby [CDNVA] : due to XDCI \ HID Activity Using AC 
</pre></td></tr></tbody></table></code></pre></div></div>

<p>使用 <code class="language-plaintext highlighter-rouge">macIASL</code> 检查设备的 <code class="language-plaintext highlighter-rouge">ACPI</code> 表, 可见 <code class="language-plaintext highlighter-rouge">XDCI</code> 设备定义了一个睡眠唤醒方法: (图中为已被 <code class="language-plaintext highlighter-rouge">patch</code> 的 <code class="language-plaintext highlighter-rouge">ACPI</code> 表)
<img src="https://user-images.githubusercontent.com/60131395/97434467-05345980-195a-11eb-8f8e-a06d7a0a3d48.png" alt="sleep" /></p>

<p>通过在 <code class="language-plaintext highlighter-rouge">OpenCore</code> 配置中将返回值改为 <code class="language-plaintext highlighter-rouge">Zero</code>, 即可完全橄榄 <code class="language-plaintext highlighter-rouge">XDCI</code> 设备的睡眠唤醒方法, 使它从此再也无法影响设备的正常睡眠. (注意截图中的高亮行)</p>

<p><img src="https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201106132053.png" alt="20201106132053" /></p>

:ET