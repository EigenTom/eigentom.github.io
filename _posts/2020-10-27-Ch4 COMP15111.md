---
layout:     post
title:      Ch4 编译原理 循环体和条件体的构造与优化
subtitle:   Iterate your iterations, Optimize your optimizations
date:       2020-10-27
author:     R1NG
header-img: img/post-bg-ios9-web.jpg
catalog: true
tags:
    - COMP15111
    - 课程笔记
    - 2020
---



## COMP15111 循环体和条件体的构造与优化

Motivation:
1. 构建 `ARM` 汇编语言循环和条件体
2. 优化循环体

## 1. 构建循环体和条件体

1. `if...else` 条件体 

   我们还是从一个简单的例子开始. 我们考虑构建以下的一个条件体: 如果变量 `total` 大于 `2000`, 则将其值减小 `100`.
   使用高级程序设计语言 `Python` 实现如下:
    ```
    if total > 2000:
        total -= 100
    ```
    条件体执行流程图如下: 

    ![20201105192732](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105192732.png)

    一般地, 对于高级程序设计语言, 条件体 `if` 的基本结构为:
    ```
    if condition: 
        action
    ```
    条件体执行流程图如下:

    ![20201105192817](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105192817.png)

    

    注:

    在 `ARM` 汇编语言中, 实现 `if` 条件体的方式有所不同:
    1. 我们需要使用条件判断指令对特定的条件进行判断. 
    2. 随后, 我们需要构造一个条件分支. 注: 一般来说, 在汇编语言中, 条件分支的执行条件是恰好与高级程序语言相反的. 

    使用高级程序设计语言实现的 `if...else` 条件体的一般结构和逻辑流程图如下:
    ```
    if condition:
        action
    else:
        alternative
    ```

    ![20201105192901](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105192901.png)

    然而, 如果我们沿用这样的逻辑, 使用汇编语言实现语句的话, 仍然会得到和预期相反的结果. 汇编语言的 `if...else` 语句应当如下实现:

    ![20201105192939](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105192939.png)



    依照高级程序设计语言的实现逻辑, 转换为汇编语言的 `if...else` 循环体实现如下:
    ```
            LDR ..., ...    //loading variables
            CMP ..., ...    //decide when to branch
            BNE skip ...;   //branch if condition not met
            <operations>    //'action' operations
    skip    <operations>    //'alternative' operations
    ```

2. `while` 循环体
   高级程序设计语言的 `while` 循环体实现方法如下:
   ```
    while condition:
        action
   ``` 

    ![20201105193011](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105193011.png)

    依照高级程序设计语言的实现逻辑, 转换为汇编语言的 `while` 循环体实现方法如下:
    ```
    start LDR ..., ...      //loading variables
          CMP ..., ...      //decide when to branch
          BGE skip ...; ... //branch
          <Several data operations>     //branch when conditions not met
          B     start       //go back to decide
    ```
<br>

## 2. 循环体优化
汇编语言的实现逻辑与特征使得如果我们简单地将高级程序设计语言的循环体/条件体思路套用的话, 将不会得到最高的效率. 为了提高程序运行的效率, 我们需要对循环体进行优化. 

优化方式有以下数种:
1. 变换操作顺序
    ![20201105193115](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105193115.png)

2. 充分利用寄存器
   ![20201105193143](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105193143.png) 

3. 利用运算特性
    ![20201105193242](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105193242.png)

4. 使用 `ARM` 的特性, 用条件指令取代分支
    ![20201105193310](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105193310.png)

优化 `for` 循环体:    
![20201105193337](https://cdn.jsdelivr.net/gh/KirisameMarisaa/KirisameMarisaa.github.io/img/blogpost_images/20201105193337.png)